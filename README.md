# 端口连通性监控系统

一个功能完整的端口连通性监控系统，支持定时检测、Web界面管理和飞书报警推送。

## 功能特性

- ✅ **Web界面管理** - 直观的任务管理界面
- ✅ **定时监控** - 支持秒/分钟/小时级别的定时检测
- ✅ **实时日志** - 详细的连通性检测日志
- ✅ **飞书报警** - 连接失败时自动推送报警消息
- ✅ **任务控制** - 支持启动/停止/删除监控任务
- ✅ **连接管理** - 检测完成后主动关闭连接，避免占用服务端资源
- ✅ **响应式设计** - 支持移动端访问

## 快速开始

### 1. 安装依赖
```bash
cd port-monitor
npm install
```

### 2. 启动服务
```bash
npm start
```

### 3. 访问系统
打开浏览器访问: http://localhost:3000

## 使用说明

### 创建监控任务

1. 点击「新建任务」按钮
2. 填写任务信息：
   - **任务名称**: 便于识别的任务名称
   - **域名/IP**: 要监控的目标地址（如：family3.cozer.cn）
   - **端口**: 要检测的端口号（如：5255）
   - **检测间隔**: 设置检测频率，支持秒/分钟/小时
3. 点击「保存」创建任务

### 管理监控任务

- **启动任务**: 点击「启动」按钮开始定时监控
- **停止任务**: 点击「停止」按钮停止定时监控
- **立即检测**: 点击「立即检测」执行一次手动检测
- **查看日志**: 点击「查看日志」查看详细的检测历史
- **编辑任务**: 点击「编辑」修改任务配置
- **删除任务**: 点击「删除」移除监控任务

### 配置飞书报警

#### 1. 创建飞书机器人

1. 在飞书群聊中，点击右上角设置图标
2. 选择「群机器人」→「添加机器人」
3. 选择「自定义机器人」
4. 设置机器人名称和描述
5. 复制生成的 Webhook URL

#### 2. 配置系统

1. 在监控系统中点击「飞书配置」按钮
2. 粘贴 Webhook URL
3. 点击「测试发送」验证配置
4. 点击「保存配置」完成设置

#### 3. 报警消息格式

当端口连接失败时，系统会自动发送如下格式的报警消息：

```
🚨 端口监控报警

任务名称: [任务名称]
目标地址: [域名:端口]
错误信息: [具体错误]
检测时间: [时间戳]
```

## 技术架构

### 后端技术栈
- **Node.js** - 运行环境
- **Express** - Web框架
- **SQLite** - 数据库
- **node-cron** - 定时任务调度
- **axios** - HTTP客户端

### 前端技术栈
- **HTML5/CSS3** - 页面结构和样式
- **JavaScript (ES6+)** - 交互逻辑
- **Font Awesome** - 图标库

### 数据库设计

#### tasks 表（监控任务）
- `id` - 主键
- `name` - 任务名称
- `hostname` - 目标域名/IP
- `port` - 目标端口
- `interval_value` - 检测间隔数值
- `interval_unit` - 检测间隔单位
- `status` - 任务状态（running/stopped）
- `created_at` - 创建时间
- `updated_at` - 更新时间

#### logs 表（检测日志）
- `id` - 主键
- `task_id` - 关联任务ID
- `status` - 检测结果（success/failed）
- `response_time` - 响应时间（毫秒）
- `error_message` - 错误信息
- `checked_at` - 检测时间

#### feishu_config 表（飞书配置）
- `id` - 主键
- `webhook_url` - 飞书机器人Webhook地址
- `created_at` - 创建时间

## API 接口

### 任务管理
- `GET /api/tasks` - 获取所有任务
- `POST /api/tasks` - 创建新任务
- `PUT /api/tasks/:id` - 更新任务
- `DELETE /api/tasks/:id` - 删除任务
- `POST /api/tasks/:id/start` - 启动任务
- `POST /api/tasks/:id/stop` - 停止任务
- `POST /api/tasks/:id/check` - 手动检测
- `GET /api/tasks/:id/logs` - 获取任务日志

### 飞书配置
- `GET /api/feishu/config` - 获取飞书配置
- `POST /api/feishu/config` - 保存飞书配置
- `POST /api/feishu/test` - 测试飞书报警

## 部署说明

### 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 生产环境
```bash
# 安装依赖
npm install --production

# 启动服务
npm start
```

### 使用 PM2 部署
```bash
# 安装 PM2
npm install -g pm2

# 启动应用
pm2 start server.js --name "port-monitor"

# 查看状态
pm2 status

# 查看日志
pm2 logs port-monitor
```

## 注意事项

1. **端口权限**: 确保运行用户有权限访问目标端口
2. **防火墙**: 检查防火墙设置，确保能够连接目标端口
3. **网络延迟**: 根据网络环境调整检测间隔，避免频繁检测
4. **资源占用**: 系统会主动关闭连接，但仍建议合理设置检测频率
5. **数据备份**: 定期备份 SQLite 数据库文件 `port_monitor.db`

## 故障排除

### 常见问题

**Q: 任务启动后没有检测日志？**
A: 检查任务状态是否为"运行中"，查看服务器控制台是否有错误信息。

**Q: 飞书报警发送失败？**
A: 确认 Webhook URL 正确，检查网络连接，使用"测试发送"功能验证配置。

**Q: 端口检测总是失败？**
A: 确认目标服务器和端口可访问，检查防火墙和网络设置。

**Q: 系统重启后任务没有自动恢复？**
A: 系统会自动恢复"运行中"状态的任务，如果没有恢复请检查数据库文件是否存在。

## 许可证

MIT License

## 作者

Andy

---

如有问题或建议，请提交 Issue 或 Pull Request。